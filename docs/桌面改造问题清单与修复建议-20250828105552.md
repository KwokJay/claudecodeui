# 桌面改造问题清单与修复建议（2025-08-28 10:55:52）

本文汇总 Electron 桌面化改造中需要关注的问题与落地建议，覆盖开发与生产两种形态。适用于当前代码库（含 `/server` 后端与 `/src` 前端）。

## 1. 开发模式端口/代理一致性
- 问题：Electron 主进程若在开发模式用“动态端口”启动服务，将与 Vite 代理（指向 `PORT || 3001`）不一致，导致前端请求失败。
- 建议（二选一）：
  - 方案 A：开发模式独立启动后端（`npm run server`），Electron 仅加载 `http://localhost:5173`，不再在 dev 启动服务。
  - 方案 B：Electron 在 dev 固定使用 `PORT=3001` 启动本地服务，并确保 Vite 代理与其一致。

## 2. 服务端导出启动函数
- 问题：`server/index.js` 目前模块加载即自启动，无法由 Electron 控制生命周期。
- 建议：导出 `startServer(options)` 并移除自启动；通过 `if (fileURLToPath(import.meta.url) === process.argv[1])` 兼容独立运行。

## 3. 生产加载方式
- 问题：使用 `loadFile('dist/index.html')` 会导致相对路径 `fetch('/api')` 在 `file://` 协议下失效。
- 建议：生产也用 `win.loadURL('http://127.0.0.1:<动态端口>')`，由本地服务托管前端与 API。

## 4. 数据库存储路径不可写
- 问题：SQLite 默认在打包资源目录，生产环境不可写。
- 建议：在主进程设置 `process.env.APP_DATA_DIR = app.getPath('userData')`；服务端使用该路径落盘 DB 并确保目录存在。

## 5. 原生依赖重建与 asar 解包
- 问题：`better-sqlite3`、`node-pty` 属原生模块，asar 内加载或 ABI 不匹配会失败。
- 建议：`electron-builder` 开启 `npmRebuild: true`；配置 `asarUnpack` 包含上述模块；必要时在 `afterPack` 执行 `electron-rebuild`。

## 6. PATH 环境修复（macOS）
- 问题：GUI 应用下 PATH 不含用户 shell 路径，找不到 `claude`、`cursor-agent`、`git`。
- 建议：主进程调用 `fix-path`（或 `shell-env`）修复 PATH，并让服务端子进程继承。

## 7. HOME 路径的跨平台性
- 问题：部分代码使用 `process.env.HOME`；Windows 下不可靠。
- 建议：统一使用 `os.homedir()`；涉及项目监控路径等位置需替换。

## 8. Vite 代理与开发重定向
- 问题：`vite.config.js` 将 `/shell` 代理到 3002，但后端把 `/ws` 与 `/shell` 均挂在同端口；`server/index.js` 在开发模式下重定向默认端口回退到 `3001`（应为 `5173`）。
- 建议：
  - 将 `/shell` 与 `/ws` 均代理到 `PORT || 3001`；
  - 开发重定向默认回退端口改为 `5173`。

## 9. `/api/config` 返回值健壮性
- 问题：返回 `wsUrl` 时不应依赖模块内 `PORT` 常量（动态端口场景下不准确）。
- 建议：始终基于 `req.headers.host` 与请求协议推导，确保反向代理/动态端口场景正确。

## 10. 安全设置
- 建议：主进程 `BrowserWindow` 开启 `contextIsolation: true`、`sandbox: true`，关闭 `nodeIntegration`；拦截新窗口并使用 `shell.openExternal` 打开外链；服务仅监听 `127.0.0.1`。

## 11. 单实例与端口占用
- 建议：使用 `app.requestSingleInstanceLock()`；服务端生产监听 `127.0.0.1:0`（系统分配端口），避免冲突。

---
以上清单可直接作为落地改造与验收的参考。建议优先处理 1、2、3、4 四项，随后推进其余修正。